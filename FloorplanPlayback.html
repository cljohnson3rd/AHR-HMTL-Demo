<!DOCTYPE html>
<!-- @noSnoop -->
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Floor Plan Playback - Temperature History</title>
    <script type='text/javascript' src='/requirejs/config.js'></script>
    <script type='text/javascript' src='/module/js/com/tridium/js/ext/require/require.min.js'></script>
    
    <style>
        :root {
            /* Light theme - Industrial minimal aesthetic */
            --bg-primary: #fafafa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f5f5f7;
            --bg-quaternary: #f0f0f3;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --text-tertiary: #6e6e73;
            --accent-primary: #007aff;
            --accent-secondary: #34c759;
            --accent-warning: #ff9500;
            --accent-error: #ff3b30;
            --border-light: #d2d2d7;
            --border-medium: #c6c6cc;
            --shadow-light: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-medium: 0 4px 16px rgba(0,0,0,0.1);
            --shadow-heavy: 0 8px 32px rgba(0,0,0,0.15);
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(255, 255, 255, 0.2);
            
            /* Temperature colors */
            --temp-cold: #2196F3;
            --temp-cool: #64B5F6;
            --temp-perfect: #4CAF50;
            --temp-warm: #FF9800;
            --temp-hot: #F44336;
            --temp-unknown: #9E9E9E;
        }

        body.dark-mode {
            /* Dark theme - Premium tech aesthetic */
            --bg-primary: #000000;
            --bg-secondary: #1c1c1e;
            --bg-tertiary: #2c2c2e;
            --bg-quaternary: #3a3a3c;
            --text-primary: #ffffff;
            --text-secondary: #98989d;
            --text-tertiary: #8e8e93;
            --accent-primary: #0a84ff;
            --accent-secondary: #32d74b;
            --accent-warning: #ff9f0a;
            --accent-error: #ff453a;
            --border-light: #38383a;
            --border-medium: #48484a;
            --shadow-light: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-medium: 0 4px 16px rgba(0,0,0,0.3);
            --shadow-heavy: 0 8px 32px rgba(0,0,0,0.4);
            --glass-bg: rgba(0, 0, 0, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Segoe UI", "SF Pro Display", -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 24px;
            right: 24px;
            width: 50px;
            height: 28px;
            background: var(--border-medium);
            border-radius: 14px;
            border: none;
            cursor: pointer;
            z-index: 1001;
            transition: all 0.3s ease;
        }

        .theme-toggle::before {
            content: '';
            position: absolute;
            left: 4px;
            top: 4px;
            width: 20px;
            height: 20px;
            background: var(--bg-secondary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-light);
        }

        body.dark-mode .theme-toggle::before {
            content: '';
            transform: translateX(22px);
        }

        .theme-toggle .icon-sun,
        .theme-toggle .icon-moon {
            position: absolute;
            left: 7px;
            top: 7px;
            width: 14px;
            height: 14px;
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none;
        }
        .theme-toggle .icon-sun {
            color: #F57F17;
            opacity: 1;
        }
        .theme-toggle .icon-moon {
            color: #90CAF9;
            opacity: 0;
        }
        body.dark-mode .theme-toggle .icon-sun { opacity: 0; transform: translateX(22px); }
        body.dark-mode .theme-toggle .icon-moon { opacity: 1; transform: translateX(22px); }


        /* Header */
        .header {
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-light);
            padding: 24px 40px;
            text-align: center;
            box-shadow: var(--shadow-light);
            position: relative;
        }

        .header h1 {
            font-family: "SF Mono", "Consolas", "Roboto Mono", monospace;
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Main Container */
        .main-container {
            padding: 40px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 32px;
            align-items: start;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* Floor Plan Container */
        .floor-plan-container {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 32px;
            box-shadow: var(--shadow-heavy);
            position: relative;
            overflow: hidden;
        }

        .heatmap-container {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-medium);
        }

        .heatmap-canvas {
            width: 100%;
            height: 600px;
            display: block;
            background: var(--bg-tertiary);
            border-radius: 12px;
        }

        /* Playback Controls */
        .playback-controls {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-medium);
        }

        .playback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .time-display {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
            font-family: "SF Mono", "Consolas", monospace;
        }

        .date-selector {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .date-selector label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .date-selector input {
            padding: 8px 12px;
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .timeline-container {
            margin-bottom: 24px;
        }

        .timeline-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Custom Timeline Slider */
        .timeline-slider {
            position: relative;
            height: 10px;
            background: var(--border-light);
            border-radius: 5px;
            margin: 20px 0;
            cursor: pointer;
        }

        .timeline-track {
            height: 100%;
            background: var(--accent-primary);
            border-radius: 5px;
            width: 0%;
            transition: width 0.1s ease;
        }

        .timeline-thumb {
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border: 2px solid var(--accent-primary);
            border-radius: 50%;
            top: 50%;
            left: 0%;
            transform: translate(-50%, -50%);
            cursor: grab;
            box-shadow: var(--shadow-medium);
            transition: transform 0.1s ease;
        }

        .timeline-thumb:active {
            cursor: grabbing;
            transform: translate(-50%, -50%) scale(1.1);
        }

        .timeline-tooltip {
            position: absolute;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.85rem;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            box-shadow: var(--shadow-medium);
        }

        .timeline-thumb:hover .timeline-tooltip {
            opacity: 1;
        }

        .playback-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .control-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: var(--accent-primary);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            box-shadow: var(--shadow-light);
        }

        .control-btn:hover {
            background: var(--accent-secondary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .speed-control {
            display: flex;
            gap: 12px;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .speed-control label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .speed-control select {
            padding: 8px 12px;
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
        }

        .quick-jump {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .quick-jump-btn {
            padding: 6px 16px;
            border: 1px solid var(--border-medium);
            border-radius: 6px;
            background: var(--bg-quaternary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .quick-jump-btn:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        /* Controls Panel */
        .controls-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-medium);
            height: fit-content;
        }

        .panel-section {
            margin-bottom: 32px;
        }

        .panel-section:last-child {
            margin-bottom: 0;
        }

        .panel-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-grid {
            display: grid;
            gap: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 6px;
            border: 2px solid var(--border-light);
            flex-shrink: 0;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .loading-progress {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: var(--bg-secondary);
            border: 2px solid var(--accent-primary);
            border-radius: 12px;
            padding: 16px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
            font-size: 0.9rem;
            max-width: 240px;
            backdrop-filter: blur(20px);
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip-title {
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--accent-primary);
            font-size: 1rem;
        }

        .tooltip-data {
            display: grid;
            gap: 4px;
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
        }

        .tooltip-label {
            color: var(--text-secondary);
        }

        .tooltip-value {
            color: var(--text-primary);
            font-weight: 600;
            font-family: "SF Mono", "Consolas", monospace;
        }

        /* Responsive Design */
        @media (max-width: 1400px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                gap: 24px;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 20px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .floor-plan-container {
                padding: 20px;
            }

            .playback-header {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <button class="theme-toggle" id="themeToggle"><svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M3.55 19.09L4.96 20.5L6.76 18.71L5.34 17.29M12 6C8.69 6 6 8.69 6 12S8.69 18 12 18 18 15.31 18 12C18 8.68 15.31 6 12 6M20 13H23V11H20M17.24 18.71L19.04 20.5L20.45 19.09L18.66 17.29M20.45 5L19.04 3.6L17.24 5.39L18.66 6.81M13 1H11V4H13M6.76 5.39L4.96 3.6L3.55 5L5.34 6.81L6.76 5.39M1 13H4V11H1M13 20H11V23H13"/></svg><svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M17.75,4.09L15.22,6.03L16.13,9.09L13.5,7.28L10.87,9.09L11.78,6.03L9.25,4.09L12.44,4L13.5,1L14.56,4L17.75,4.09M21.25,11L19.61,12.25L20.2,14.23L18.5,13.06L16.8,14.23L17.39,12.25L15.75,11L17.81,10.95L18.5,9L19.19,10.95L21.25,11M18.97,15.95C19.8,15.87 20.69,17.05 20.16,17.8C19.84,18.25 19.5,18.67 19.08,19.07C15.17,23 8.84,23 4.94,19.07C1.03,15.17 1.03,8.83 4.94,4.93C5.34,4.53 5.76,4.17 6.21,3.85C6.96,3.32 8.14,4.21 8.06,5.04C7.79,7.9 8.75,10.87 10.95,13.06C13.14,15.26 16.1,16.22 18.97,15.95M17.33,17.97C14.5,17.81 11.7,16.64 9.53,14.5C7.36,12.31 6.2,9.5 6.04,6.68C3.23,9.82 3.34,14.64 6.35,17.66C9.37,20.67 14.19,20.78 17.33,17.97Z"/></svg></button>

    <!-- Header -->
    <header class="header">
        <div style="position: absolute; top: 20px; left: 20px; display: flex; gap: 10px;">
            <button onclick="goToLiveView()" style="background: var(--accent-secondary); border: none; color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s ease;">
                <svg style="width:1em;height:1em;vertical-align:middle;fill:currentColor" viewBox="0 0 24 24"><path d="M12,11.5A2.5,2.5 0 0,1 9.5,9A2.5,2.5 0 0,1 12,6.5A2.5,2.5 0 0,1 14.5,9A2.5,2.5 0 0,1 12,11.5M12,2A7,7 0 0,0 5,9C5,14.25 12,22 12,22C12,22 19,14.25 19,9A7,7 0 0,0 12,2Z"/></svg> Live View
            </button>
        </div>
        <h1><svg style="width:1em;height:1em;vertical-align:middle;fill:currentColor" viewBox="0 0 24 24"><path d="M18,9H16V7H18M18,13H16V11H18M18,17H16V15H18M8,9H6V7H8M8,13H6V11H8M8,17H6V15H8M18,3V5H16V3H8V5H6V3H4V21H6V19H8V21H16V19H18V21H20V3H18Z"/></svg> Floor Plan Playback</h1>
        <p>Historical temperature visualization and playback controls</p>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <div class="dashboard-container">
            <div class="main-content">
                <!-- Floor Plan -->
                <div class="floor-plan-container">
                    <div class="heatmap-container">
                        <canvas id="heatmapCanvas" class="heatmap-canvas" width="1600" height="1000"></canvas>
                    </div>
                </div>

                <!-- Playback Controls -->
                <div class="playback-controls">
                    <div class="playback-header">
                        <div class="time-display" id="timeDisplay">12:00 AM</div>
                        <div class="date-selector">
                            <label for="dateInput">Date:</label>
                            <input type="date" id="dateInput" />
                            <button class="control-btn" onclick="loadHistoryData()">Load Data</button>
                        </div>
                    </div>

                    <div class="timeline-container">
                        <div class="timeline-label">
                            <span>12:00 AM</span>
                            <span>6:00 AM</span>
                            <span>12:00 PM</span>
                            <span>6:00 PM</span>
                            <span>11:45 PM</span>
                        </div>
                        <div class="timeline-slider" id="timeline-slider">
                            <div class="timeline-track" id="timeline-track"></div>
                            <div class="timeline-thumb" id="timeline-thumb">
                                <div class="timeline-tooltip" id="timeline-tooltip">12:00 AM</div>
                            </div>
                        </div>
                    </div>

                    <div class="playback-buttons">
                        <button class="control-btn" id="playBtn" onclick="togglePlayback()"><svg style="width:1em;height:1em;vertical-align:middle;fill:currentColor" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/></svg> Play</button>
                        <button class="control-btn" onclick="stopPlayback()">⏹ Stop</button>
                    </div>

                    <div class="speed-control">
                        <label>Playback Speed:</label>
                        <select id="speedControl">
                            <option value="1000">1x (1 sec/interval)</option>
                            <option value="500" selected>2x (0.5 sec/interval)</option>
                            <option value="250">4x (0.25 sec/interval)</option>
                            <option value="125">8x (0.125 sec/interval)</option>
                        </select>
                    </div>

                    <div class="quick-jump">
                        <button class="quick-jump-btn" onclick="jumpToTime(0)">Midnight</button>
                        <button class="quick-jump-btn" onclick="jumpToTime(24)">6:00 AM</button>
                        <button class="quick-jump-btn" onclick="jumpToTime(48)">Noon</button>
                        <button class="quick-jump-btn" onclick="jumpToTime(72)">6:00 PM</button>
                    </div>
                </div>
            </div>

            <!-- Controls Panel -->
            <div class="controls-panel">
                <!-- Temperature Legend -->
                <div class="panel-section">
                    <div class="panel-title">
                        <svg style="width:1em;height:1em;vertical-align:middle;fill:currentColor" viewBox="0 0 24 24"><path d="M15 13V5A3 3 0 0 0 9 5V13A5 5 0 1 0 15 13M12 4A1 1 0 0 1 13 5V8H11V5A1 1 0 0 1 12 4Z"/></svg> Temperature Legend
                    </div>
                    <div class="legend-grid">
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--temp-cold);"></div>
                            <span>Cold (≤ SP - 3°F)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--temp-cool);"></div>
                            <span>Cool (SP - 1.5°F)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--temp-perfect);"></div>
                            <span>Perfect (SP ± 1.5°F)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--temp-warm);"></div>
                            <span>Warm (SP + 1.5°F)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--temp-hot);"></div>
                            <span>Hot (≥ SP + 3°F)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--temp-unknown);"></div>
                            <span>No Data</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Historical Data...</div>
        <div class="loading-progress" id="loadingProgress">0 / 20 VAVs</div>
    </div>

    <div class="tooltip" id="tooltip">
        <div class="tooltip-title" id="tooltipTitle"></div>
        <div class="tooltip-data" id="tooltipData"></div>
    </div>

    <script>
        // Theme Management
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;
        
        // Initialize theme from localStorage
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
            body.classList.add('dark-mode');
        }
        
        themeToggle.addEventListener('click', () => {
            body.classList.toggle('dark-mode');
            const currentTheme = body.classList.contains('dark-mode') ? 'dark' : 'light';
            localStorage.setItem('theme', currentTheme);
        });

        // Navigation function
        window.goToLiveView = function() {
            const url = '/ord/file:%5EFiles/Floorplan.html%7Cview:web:FileDownloadView';
            window.location.href = url;
        };

        require(['baja!'], function (baja) {
            'use strict';

            // Zone definitions from your existing floor plan
            const zoneDefinitions = [
                { id: 1, name: 'VAV-01', polygon: [1350,620, 1450,620, 1460,790, 1360,790] },
                { id: 2, name: 'VAV-02', polygon: [440,70, 440,80, 450,80, 440,260, 540,260, 550,70] },
                { id: 3, name: 'VAV-03', polygon: [1050,760, 1050,860, 1040,860, 1040,880, 1370,880, 1360,800, 1350,790, 1350,760] },
                { id: 4, name: 'VAV-04', polygon: [1060,80, 1160,80, 1160,180, 1060,180] },
                { id: 5, name: 'VAV-05', polygon: [1060,220, 1170,220, 1170,320, 1100,320, 1100,360, 1060,360] },
                { id: 6, name: 'VAV-06', polygon: [670,450, 810,450, 810,480, 840,480, 840,470, 880,470, 880,530, 670,530] },
                { id: 7, name: 'VAV-07', polygon: [230,70, 400,70, 390,240, 310,240, 310,270, 210,270] },
                { id: 8, name: 'VAV-08', polygon: [850,80, 950,80, 950,180, 850,180] },
                { id: 9, name: 'VAV-09', polygon: [1170,80, 1390,80, 1410,330, 1380,330, 1380,360, 1180,360] },
                { id: 10, name: 'VAV-10', polygon: [920,430, 1060,430, 1060,390, 1130,390, 1130,530, 920,530] },
                { id: 11, name: 'VAV-11', polygon: [175,680, 335,680, 325,870, 155,870] },
                { id: 12, name: 'VAV-12', polygon: [555,70, 650,70, 650,330, 435,330, 445,270, 545,270] },
                { id: 13, name: 'VAV-13', polygon: [715,80, 845,80, 845,180, 715,180] },
                { id: 14, name: 'VAV-14', polygon: [985,535, 1115,535, 1115,620, 985,620] },
                { id: 15, name: 'VAV-15', polygon: [880,220, 880,420, 1030,420, 1020,220] },
                { id: 16, name: 'VAV-16', polygon: [430,370, 570,370, 570,490, 420,490] },
                { id: 17, name: 'VAV-17', polygon: [190,570, 340,570, 340,670, 190,670, 190,650, 180,650] },
                { id: 18, name: 'VAV-18', polygon: [420,500, 570,500, 570,570, 410,570] },
                { id: 19, name: 'VAV-19', polygon: [670,370, 870,370, 870,420, 840,420, 840,410, 810,410, 810,440, 670,440] },
                { id: 20, name: 'VAV-20', polygon: [960,80, 1050,80, 1050,180, 960,180] }
            ];

            // Global variables
            let historicalData = {}; // Format: { vavId: { timeIndex: { temp, sp }, ... }, ... }
            let playbackInterval;
            let isPlaying = false;
            let currentTimeIndex = 0;
            let canvas, ctx;
            let backgroundImg = null;
            let backgroundLoaded = false;
            
            // Timeline slider variables
            let timelineSlider, timelineTrack, timelineThumb, timelineTooltip;
            let isDragging = false;

            // Initialize date input to today
            document.getElementById('dateInput').valueAsDate = new Date();

            // Initialize canvas
            function initCanvas() {
                canvas = document.getElementById('heatmapCanvas');
                ctx = canvas.getContext('2d');
                
                // Add mouse interaction
                canvas.addEventListener('mousemove', handleMouseMove);
                canvas.addEventListener('mouseleave', hideTooltip);
            }

            // Load background image
            function loadBackgroundImage() {
                const img = new Image();
                img.onload = function() {
                    backgroundImg = img;
                    backgroundLoaded = true;
                    render();
                };
                img.onerror = function() {
                    console.warn('Failed to load floor plan image, using grid fallback');
                    render();
                };
                img.src = '/file/images/Floorplans_3D_Grey_01.png';
            }

            // Initialize timeline slider
            function initTimelineSlider() {
                timelineSlider = document.getElementById('timeline-slider');
                timelineTrack = document.getElementById('timeline-track');
                timelineThumb = document.getElementById('timeline-thumb');
                timelineTooltip = document.getElementById('timeline-tooltip');

                setTimelinePosition(0);

                timelineThumb.addEventListener('mousedown', startDrag);
                timelineSlider.addEventListener('click', handleSliderClick);
                
                document.addEventListener('mousemove', handleDrag);
                document.addEventListener('mouseup', stopDrag);

                timelineThumb.addEventListener('touchstart', startDrag);
                document.addEventListener('touchmove', handleDrag);
                document.addEventListener('touchend', stopDrag);
            }

            function startDrag(event) {
                event.preventDefault();
                isDragging = true;
                timelineThumb.style.cursor = 'grabbing';
            }

            function handleSliderClick(event) {
                if (isDragging || event.target === timelineThumb) return;
                
                const rect = timelineSlider.getBoundingClientRect();
                const clickX = event.clientX - rect.left;
                const percentage = Math.max(0, Math.min(1, clickX / rect.width));
                const newIndex = Math.round(percentage * 95);
                
                setTimelinePosition(newIndex);
                updateTimeIndex(newIndex);
            }

            function handleDrag(event) {
                if (!isDragging) return;
                
                event.preventDefault();
                const clientX = event.clientX || (event.touches && event.touches[0].clientX);
                if (!clientX) return;
                
                const rect = timelineSlider.getBoundingClientRect();
                const dragX = clientX - rect.left;
                const percentage = Math.max(0, Math.min(1, dragX / rect.width));
                const newIndex = Math.round(percentage * 95);
                
                setTimelinePosition(newIndex);
                updateTimeIndex(newIndex);
            }

            function stopDrag() {
                isDragging = false;
                timelineThumb.style.cursor = 'grab';
            }

            function setTimelinePosition(timeIndex) {
                const percentage = (timeIndex / 95) * 100;
                timelineTrack.style.width = percentage + '%';
                timelineThumb.style.left = percentage + '%';
                timelineTooltip.textContent = indexToTime(timeIndex);
            }

            function updateTimeIndex(index) {
                currentTimeIndex = index;
                updateFloorPlan(index);
                document.getElementById('timeDisplay').textContent = indexToTime(index);
            }

            function indexToTime(index) {
                const totalMinutes = index * 15;
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                const period = hours < 12 ? 'AM' : 'PM';
                const displayHours = hours === 0 ? 12 : (hours > 12 ? hours - 12 : hours);
                return `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
            }

            // Get temperature color based on deviation from setpoint
            function getHeatmapColor(spaceTemp, effSP) {
                if (spaceTemp === null || effSP === null || isNaN(spaceTemp) || isNaN(effSP)) {
                    return null;
                }
                
                const deviation = spaceTemp - effSP;
                
                if (deviation <= -3) return '#2196F3';
                if (deviation <= -1.5) return '#64B5F6';
                if (deviation <= 1.5) return '#4CAF50';
                if (deviation <= 3) return '#FF9800';
                return '#F44336';
            }

            // Get polygon bounds for zone center calculation
            function getPolygonBounds(polygon) {
                let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                for (let i = 0; i < polygon.length; i += 2) {
                    minX = Math.min(minX, polygon[i]);
                    maxX = Math.max(maxX, polygon[i]);
                    minY = Math.min(minY, polygon[i + 1]);
                    maxY = Math.max(maxY, polygon[i + 1]);
                }
                return { minX, minY, maxX, maxY, centerX: (minX + maxX) / 2, centerY: (minY + maxY) / 2 };
            }

            // Draw zone with gradient and temperature text
            function drawZoneWithGradient(zone, baseColor, tempValue, spValue) {
                if (!baseColor) return;
                
                const polygon = zone.polygon;
                if (polygon.length < 6) return;
                
                ctx.save();
                
                // Create clipping path for zone
                ctx.beginPath();
                ctx.moveTo(polygon[0], polygon[1]);
                for (let i = 2; i < polygon.length; i += 2) {
                    ctx.lineTo(polygon[i], polygon[i + 1]);
                }
                ctx.closePath();
                ctx.clip();
                
                // Calculate zone bounds and center
                const bounds = getPolygonBounds(polygon);
                const maxRadius = Math.max(bounds.maxX - bounds.minX, bounds.maxY - bounds.minY) * 0.6;
                
                // Create radial gradient
                const gradient = ctx.createRadialGradient(
                    bounds.centerX, bounds.centerY, 0,
                    bounds.centerX, bounds.centerY, maxRadius
                );
                
                // Parse color for gradient
                const rgbMatch = baseColor.match(/#([0-9A-Fa-f]{6})/);
                let r, g, b;
                
                if (rgbMatch) {
                    const hex = rgbMatch[1];
                    r = parseInt(hex.substr(0, 2), 16);
                    g = parseInt(hex.substr(2, 2), 16);
                    b = parseInt(hex.substr(4, 2), 16);
                } else {
                    r = g = b = 128;
                }
                
                // Create gradient with good opacity
                gradient.addColorStop(0, `rgba(${r}, ${g}, ${b}, 0.7)`);
                gradient.addColorStop(0.7, `rgba(${Math.floor(r * 0.8)}, ${Math.floor(g * 0.8)}, ${Math.floor(b * 0.8)}, 0.5)`);
                gradient.addColorStop(1, `rgba(${Math.floor(r * 0.6)}, ${Math.floor(g * 0.6)}, ${Math.floor(b * 0.6)}, 0.3)`);
                
                ctx.fillStyle = gradient;
                ctx.fill();
                
                ctx.restore();

                // Draw temperature text in zone center
                if (tempValue !== null && !isNaN(tempValue)) {
                    ctx.save();
                    ctx.font = 'bold 16px "SF Mono", "Consolas", monospace';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    // Adjust text position for specific VAVs to avoid overlaps
                    let textX = bounds.centerX;
                    let textY = bounds.centerY;
                    
                    if (zone.id === 12) {
                        // Move VAV-12 text to avoid overlap with VAV-02
                        textX = bounds.centerX + 40;
                        textY = bounds.centerY + 30;
                    }
                    
                    const tempText = `${tempValue.toFixed(1)}°F`;
                    
                    // Semi-transparent background for text readability
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
                    const textMetrics = ctx.measureText(tempText);
                    const textWidth = textMetrics.width + 8;
                    const textHeight = 18;
                    
                    ctx.fillRect(
                        textX - textWidth/2, 
                        textY - textHeight/2, 
                        textWidth, 
                        textHeight
                    );
                    
                    // Draw text in white for good contrast
                    ctx.fillStyle = '#ffffff';
                    ctx.fillText(tempText, textX, textY);
                    
                    // Draw VAV name below temperature
                    ctx.font = 'bold 12px "SF Mono", "Consolas", monospace';
                    ctx.fillStyle = '#ffffff';
                    ctx.fillText(zone.name, textX, textY + 25);
                    
                    ctx.restore();
                }
            }

            // Main render function
            function render() {
                if (!ctx) return;
                
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw background image
                if (backgroundImg && backgroundLoaded) {
                    ctx.drawImage(backgroundImg, 110, 40, 1400, 900);
                } else {
                    // Grid fallback
                    ctx.fillStyle = '#f8f9fa';
                    ctx.fillRect(110, 40, 1400, 900);
                    
                    ctx.strokeStyle = '#ddd';
                    ctx.lineWidth = 1;
                    ctx.setLineDash([5, 5]);
                    
                    for (let x = 110; x <= 1510; x += 100) {
                        ctx.beginPath();
                        ctx.moveTo(x, 40);
                        ctx.lineTo(x, 940);
                        ctx.stroke();
                    }
                    
                    for (let y = 40; y <= 940; y += 100) {
                        ctx.beginPath();
                        ctx.moveTo(110, y);
                        ctx.lineTo(1510, y);
                        ctx.stroke();
                    }
                    
                    ctx.setLineDash([]);
                }
                
                // Draw zones with temperature colors and text for current time
                updateFloorPlan(currentTimeIndex);
            }

            // Update floor plan based on time index - NOW WITH TEMPERATURE DISPLAY
            function updateFloorPlan(timeIndex) {
                if (!ctx) return;
                
                // Redraw background
                if (backgroundImg && backgroundLoaded) {
                    ctx.drawImage(backgroundImg, 110, 40, 1400, 900);
                } else {
                    ctx.fillStyle = '#f8f9fa';
                    ctx.fillRect(110, 40, 1400, 900);
                }
                
                // Draw zones with temperature colors and values for current time index
                zoneDefinitions.forEach(zone => {
                    const data = historicalData[zone.id] && historicalData[zone.id][timeIndex];
                    
                    if (data && data.temp !== null && data.sp !== null) {
                        const color = getHeatmapColor(data.temp, data.sp);
                        if (color) {
                            drawZoneWithGradient(zone, color, data.temp, data.sp);
                        }
                    }
                });
            }

            // Mouse interaction handlers
            function handleMouseMove(event) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const x = (event.clientX - rect.left) * scaleX;
                const y = (event.clientY - rect.top) * scaleY;
                
                // Check if mouse is over any zone
                for (const zone of zoneDefinitions) {
                    if (isPointInPolygon(x, y, zone.polygon)) {
                        showTooltip(event, zone);
                        canvas.style.cursor = 'pointer';
                        return;
                    }
                }
                
                canvas.style.cursor = 'default';
                hideTooltip();
            }

            // Point in polygon test
            function isPointInPolygon(x, y, polygon) {
                let inside = false;
                for (let i = 0, j = polygon.length - 2; i < polygon.length; j = i, i += 2) {
                    const xi = polygon[i], yi = polygon[i + 1];
                    const xj = polygon[j], yj = polygon[j + 1];
                    
                    if (((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi)) {
                        inside = !inside;
                    }
                }
                return inside;
            }

            // Show tooltip with historical VAV information
            function showTooltip(event, zone) {
                const tooltip = document.getElementById('tooltip');
                const data = historicalData[zone.id] && historicalData[zone.id][currentTimeIndex];
                
                document.getElementById('tooltipTitle').textContent = `${zone.name} - ${indexToTime(currentTimeIndex)}`;
                
                let dataHtml = '<div class="tooltip-data">';
                if (data && data.temp !== null && !isNaN(data.temp)) {
                    dataHtml += `<div class="tooltip-row">
                        <span class="tooltip-label">Space Temp:</span>
                        <span class="tooltip-value">${data.temp.toFixed(1)}°F</span>
                    </div>`;
                    dataHtml += `<div class="tooltip-row">
                        <span class="tooltip-label">Setpoint:</span>
                        <span class="tooltip-value">${data.sp ? data.sp.toFixed(1) + '°F' : 'N/A'}</span>
                    </div>`;
                    if (data.sp && !isNaN(data.sp)) {
                        const deviation = data.temp - data.sp;
                        dataHtml += `<div class="tooltip-row">
                            <span class="tooltip-label">Deviation:</span>
                            <span class="tooltip-value">${deviation >= 0 ? '+' : ''}${deviation.toFixed(1)}°F</span>
                        </div>`;
                    }
                } else {
                    dataHtml += '<div>No data for this time</div>';
                }
                dataHtml += '</div>';
                
                document.getElementById('tooltipData').innerHTML = dataHtml;
                tooltip.classList.add('visible');
                
                // Position tooltip
                const offsetX = 25;
                const offsetY = 25;
                let left = event.pageX + offsetX;
                let top = event.pageY + offsetY;
                
                const tooltipRect = tooltip.getBoundingClientRect();
                if (left + tooltipRect.width > window.innerWidth) {
                    left = event.pageX - tooltipRect.width - offsetX;
                }
                if (top + tooltipRect.height > window.innerHeight) {
                    top = event.pageY - tooltipRect.height - offsetY;
                }
                
                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';
            }

            function hideTooltip() {
                document.getElementById('tooltip').classList.remove('visible');
            }

            // Load historical data for selected date
            window.loadHistoryData = function() {
                const dateInput = document.getElementById('dateInput');
                const selectedDateStr = dateInput.value;
                
                if (!selectedDateStr) {
                    alert('Please select a date');
                    return;
                }
                
                // Parse date manually to avoid timezone issues
                const [year, month, day] = selectedDateStr.split('-');
                const selectedDate = {
                    startOf: (unit) => {
                        if (unit === 'day') {
                            return {
                                toISOString: () => `${year}-${month}-${day}T00:00:00.000Z`
                            };
                        }
                    },
                    diff: (other, unit) => {
                        const thisTime = new Date(`${year}-${month}-${day}T00:00:00.000Z`);
                        const otherTime = new Date(other.toISOString());
                        const diffMs = thisTime.getTime() - otherTime.getTime();
                        if (unit === 'minute') {
                            return Math.floor(diffMs / (1000 * 60));
                        }
                        return diffMs;
                    }
                };
                
                // Reset data
                historicalData = {};
                stopPlayback();
                
                // Show loading overlay
                document.getElementById('loadingOverlay').style.display = 'flex';
                document.getElementById('loadingProgress').textContent = '0 / 20 VAVs';
                
                let completedVAVs = 0;
                const promises = [];

                zoneDefinitions.forEach(zone => {
                    const vavFolder = zone.id.toString().padStart(2, '0');
                    
                    const spaceTempPromise = discoverAndLoadHistory(
                        `station:|slot:/VAVs/VAV${vavFolder}/SpaceTemp`,
                        selectedDate,
                        zone.id,
                        'temp'
                    );
                    
                    const effSPPromise = discoverAndLoadHistory(
                        `station:|slot:/VAVs/VAV${vavFolder}/EffSP`,
                        selectedDate,
                        zone.id,
                        'sp'
                    );

                    promises.push(
                        Promise.all([spaceTempPromise, effSPPromise]).then(() => {
                            completedVAVs++;
                            document.getElementById('loadingProgress').textContent = 
                                `${completedVAVs} / 20 VAVs`;
                        })
                    );
                });

                Promise.all(promises)
                    .then(() => {
                        document.getElementById('loadingOverlay').style.display = 'none';
                        console.log('All historical data loaded successfully');
                        setTimelinePosition(0);
                        updateTimeIndex(0);
                    })
                    .catch(err => {
                        document.getElementById('loadingOverlay').style.display = 'none';
                        console.error('Error loading historical data:', err);
                        alert('Failed to load some historical data. Check console for details.');
                    });
            };

            // Discover and load history (same pattern as your other files)
            function discoverAndLoadHistory(pointOrd, selectedDate, vavId, dataType) {
                return new Promise((resolve, reject) => {
                    console.log(`Auto-discovering history from point: ${pointOrd}`);
                    
                    baja.Ord.make(pointOrd).get()
                        .then(function(entity) {
                            return entity.tags();
                        })
                        .then(function(tagMap) {
                            const historyTag = tagMap.get('n:history');
                            console.log(`Found history tag for ${dataType}:`, historyTag);
                            
                            if (historyTag && historyTag.toString().trim() !== '') {
                                let historyPath = historyTag.toString();
                                if (!historyPath.startsWith('history:')) {
                                    historyPath = 'history:' + historyPath;
                                }
                                console.log(`Using history ORD: ${historyPath}`);
                                
                                return loadVAVHistory(historyPath, selectedDate, vavId, dataType);
                            } else {
                                console.warn(`No n:history tag found on point: ${pointOrd}`);
                                resolve();
                            }
                        })
                        .then(() => {
                            resolve();
                        })
                        .catch(function(err) {
                            console.error(`Couldn't load tags for ${pointOrd}:`, err);
                            resolve();
                        });
                });
            }

            function loadVAVHistory(historyOrd, selectedDate, vavId, dataType) {
                return new Promise((resolve, reject) => {
                    const startTime = selectedDate.startOf('day').toISOString();
                    const bqlQuery = `${historyOrd}|bql:select timestamp, value where timestamp >= '${startTime}'`;
                    const queryOrd = baja.Ord.make(bqlQuery);
                    
                    console.log(`Fetching ${dataType} data with BQL ORD: ${bqlQuery}`);

                    const tempData = new Array(96).fill(null);

                    queryOrd.get({
                        cursor: {
                            limit: 10000,
                            each: function (row) {
                                const rawTimestamp = row.get("timestamp");
                                const timestamp = new Date(rawTimestamp);
                                const value = row.get("value");
                                
                                const startOfDay = new Date(selectedDate.startOf('day').toISOString());
                                const minutesFromMidnight = Math.floor((timestamp.getTime() - startOfDay.getTime()) / (1000 * 60));
                                const timeIndex = Math.floor(minutesFromMidnight / 15);
                                
                                if (timeIndex >= 0 && timeIndex < 96) {
                                    tempData[timeIndex] = value;
                                }
                            }
                        }
                    })
                    .then(function () {
                        console.log(`Successfully fetched ${dataType} data for VAV${vavId}`);
                        
                        if (!historicalData[vavId]) {
                            historicalData[vavId] = {};
                        }
                        
                        tempData.forEach((value, index) => {
                            if (!historicalData[vavId][index]) {
                                historicalData[vavId][index] = { temp: null, sp: null };
                            }
                            historicalData[vavId][index][dataType] = value;
                        });
                        
                        resolve();
                    })
                    .catch(function (err) {
                        console.error(`Error loading history data from ${historyOrd}:`, err);
                        resolve();
                    });
                });
            }

            // Playback controls
            window.togglePlayback = function() {
                if (isPlaying) {
                    pausePlayback();
                } else {
                    startPlayback();
                }
            };

            function startPlayback() {
                isPlaying = true;
                document.getElementById('playBtn').innerHTML = '⏸ Pause';
                
                const speed = parseInt(document.getElementById('speedControl').value);
                
                playbackInterval = setInterval(() => {
                    currentTimeIndex++;
                    if (currentTimeIndex > 95) {
                        stopPlayback();
                        return;
                    }
                    setTimelinePosition(currentTimeIndex);
                    updateTimeIndex(currentTimeIndex);
                }, speed);
            }

            function pausePlayback() {
                isPlaying = false;
                document.getElementById('playBtn').innerHTML = '<svg style="width:1em;height:1em;vertical-align:middle;fill:currentColor" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/></svg> Play';
                clearInterval(playbackInterval);
            }

            window.stopPlayback = function() {
                pausePlayback();
                currentTimeIndex = 0;
                setTimelinePosition(0);
                updateTimeIndex(0);
            };

            window.jumpToTime = function(index) {
                stopPlayback();
                setTimelinePosition(index);
                updateTimeIndex(index);
            };

            // Initialize everything
            function init() {
                initCanvas();
                initTimelineSlider();
                loadBackgroundImage();
                render();
                
                // Auto-load today's data
                loadHistoryData();
            }

            // Cleanup on page unload
            window.addEventListener('beforeunload', function() {
                if (playbackInterval) clearInterval(playbackInterval);
            });

            // Start the application
            init();
        });
    </script>
</body>
</html>